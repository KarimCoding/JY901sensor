//
// Function that save the time output packet to a text file 
//
//#include <SerialStream.h>
#include <iostream>
#include <fstream>
#include <iomanip>
#include <unistd.h>
#include <cstdlib>
#include <new>

#include "wgdaytime.h"


#include <sys/time.h>
#include <time.h>
#include <stdlib.h>
#include <stdio.h>

using namespace std;

bool flag(false);
int iTime = 0;
unsigned char timeArray[11];
long double yearP;
long double monthP;
long double dayP;
long double hourP;
long double minuteP;
long double secondP;
long double msecondP;
long double timeP;

void timeOutput(unsigned char timeArray[], FILE *&outF)
{


  char buffer[30];
  struct timeval tv;

  time_t curtime;



  gettimeofday(&tv, NULL); 
  curtime=tv.tv_sec;

  strftime(buffer,30,"%T.",localtime(&curtime));

	    //converting into milliseconds 
	    yearP= ((int)(timeArray[2]))*31540000000;
	    monthP= ((int)(timeArray[3]))*2628000000;
	    dayP= ((int)(timeArray[4]))*86400000;
	    hourP= ((int)(timeArray[5]))*3600000;
	    minuteP= ((int)(timeArray[6]))*60000;
	    secondP= ((int)(timeArray[7]))*1000;
	    msecondP= ((int)(((int)(timeArray[9])) << 8)) + ((int)(timeArray[8]));
	    timeP = yearP + monthP + dayP + hourP + minuteP + secondP + msecondP; // adding the time together, all in milliseconds
    
		printf(" %02u %02u\n",timeArray[9],timeArray[8]);
//  printf("%s%ld\n",buffer,tv.tv_usec);

		printf("20%d/%d/%d %d:%d:%d:%d \n",(int)(timeArray[2]),(int)(timeArray[3]),(int)timeArray[4],(int)timeArray[5],(int)timeArray[6],(int)timeArray[7],msecondP);   
		printf("%s%ld\n",buffer,tv.tv_usec);


	    for(iTime=0; iTime < 11 ; iTime++)
        {
	     fprintf(outF,"%02x ",timeArray[iTime]); 
        }
        fprintf(outF,"       %d",((long int)gettimeofdayInMilliSeconds()));
        fprintf(outF,"    %f",((long double)(timeP)) );
        fprintf(outF,"    %f\n", ((long double)(timeP)) - ((long int)gettimeofdayInMilliSeconds()));
	iTime=1;
}
